<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trump vs Biden Word Cloud</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"></script>
    
</head>

<script>
    function createWordCloud() {
        d3.json("filtered_word_count.json").then(function(data) {
            // Combine Trump and Biden data
            var combinedWords = data.data.map(d => ({
                text: d[0],
                size: d[1] + d[2],  // Sum of TRUMP and BIDEN counts
                trump: d[1],
                biden: d[2]
            }));

            // Set the dimensions and margins of the graph
            var margin = {top: 10, right: 10, bottom: 10, left: 10},
                width = 800 - margin.left - margin.right,
                height = 600 - margin.top - margin.bottom;

            // Append the svg object to the body of the page
            var svg = d3.select("#wordcloud").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // Constructs a new cloud layout instance
            var layout = d3.layout.cloud()
                .size([width, height])
                .words(combinedWords)
                .padding(5)
                .rotate(function() { return ~~(Math.random() * 2) * 90; })
                .fontSize(function(d) { return Math.sqrt(d.size) * 10; })
                .on("end", draw);

            layout.start();

            // This function draws the words
            function draw(words) {
                svg.append("g")
                    .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                    .selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", function(d) { return d.size + "px"; })
                    .style("fill", function(d) { 
                        // Color words based on which candidate used them more
                        if (d.trump > d.biden) return "red";  // TRUMP
                        else if (d.biden > d.trump) return "blue";  // BIDEN
                        else return "purple"; // If used equally
                    })
                    .attr("text-anchor", "middle")
                    .attr("transform", function(d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                    .text(function(d) { return d.text; });
            }
        });
    }


    function createChartAndDropdown() {
    Promise.all([
        d3.json("words.json"),
        d3.json("speaker_texts.json")
    ]).then(function([wordData, textData]) {
        const text = Object.keys(wordData.TRUMP);

        // Populate dropdown
        const select = d3.select("#wordSelect")
                .selectAll("option")
                .data(text)
                .enter()
                .append("option")
                .text(d => d)
                .attr("value", d => d);

        // Set up SVG
        const margin = {top: 20, right: 20, bottom: 30, left: 40};
        const width = 600 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#chart")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Set up scales
        const x = d3.scaleBand()
            .range([0, width])
            .padding(0.1);

        const y = d3.scaleLinear()
            .range([height, 0]);

        // Add axes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .attr("class", "x-axis");

        svg.append("g")
            .attr("class", "y-axis");

        // Function to update chart and text
        function updateChartAndText(selectedWord) {
            const chartData = [
                {name: "Trump", value: wordData.TRUMP[selectedWord]},
                {name: "Biden", value: wordData.BIDEN[selectedWord]}
            ];

            // Update result div
            d3.select("#trumpCount").text(wordData.TRUMP[selectedWord]);
            d3.select("#bidenCount").text(wordData.BIDEN[selectedWord]);

            // Find sentences containing the selected word
            let trumpSentences = findSentences(textData.TRUMP, selectedWord);
            let bidenSentences = findSentences(textData.BIDEN, selectedWord);

            // Update text box with found sentences
            updateTextBox(trumpSentences, bidenSentences);

            // Update chart
            x.domain(chartData.map(d => d.name));
            y.domain([0, d3.max(chartData, d => d.value)]);

            svg.select(".x-axis")
                .call(d3.axisBottom(x));

            svg.select(".y-axis")
                .call(d3.axisLeft(y));

            const bars = svg.selectAll(".bar")
                .data(chartData);

            bars.enter()
                .append("rect")
                .attr("class", "bar")
                .merge(bars)
                .transition()
                .duration(1000)
                .attr("x", d => x(d.name))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.value))
                .attr("fill", (d, i) => i === 0 ? "red" : "blue");

            bars.exit().remove();
        }

        // Function to find sentences containing the word
        function findSentences(speeches, word) {
            let sentences = [];
            speeches.forEach(speech => {
                let matchingSentences = speech.split('\n')
                    .filter(sentence => sentence.toLowerCase().includes(word.toLowerCase()));
                sentences = sentences.concat(matchingSentences);
            });
            return sentences;
        }

    function updateTextBox(trumpSentences, bidenSentences) {
    // Limit sentences to 150 characters
    const limitSentence = (sentence) => sentence.length > 150 ? sentence.substring(0, 147) + '...' : sentence;

    let bidenLimitedSentences = bidenSentences.map(limitSentence);
    let trumpLimitedSentences = trumpSentences.map(limitSentence);

    let bidenContent = "Biden sentences:\n" + bidenLimitedSentences.join("\n\n");
    let trumpContent = "Trump sentences:\n" + trumpLimitedSentences.join("\n\n");
    
    d3.select("#bidenSentencesBox")
        .text(bidenContent);

    d3.select("#trumpSentencesBox")
        .text(trumpContent);
}
        // Event listener for dropdown
        d3.select("#wordSelect").on("change", function() {
            updateChartAndText(this.value);
        });

        // Initial update
        updateChartAndText(text[0]);
    });
}  

// Call both functions when the page loads
document.addEventListener('DOMContentLoaded', (event) => {
    createWordCloud();
    createChartAndDropdown();
});

</script>

<body>
    <div class="article-body">
    <h1>Trump vs Biden Word Cloud</h1>
    <div id="wordcloud"></div>

    <div class="dropdown">
        <label for="wordSelect">Select a word: </label>
        <select id="wordSelect"></select>
    </div>
    <div class="result" id="result">
        Trump: <span id="trumpCount">0</span><br>
        Biden: <span id="bidenCount">0</span>
    </div>

    <div id="chart"></div>

    <div id="bidenSentencesBox"></div>
    <div id="trumpSentencesBox"></div>
</div>

<style>
    .article-body {
        max-width: 800px;
        margin-left: 20%;
        margin-right: 20%;
    }

    #wordcloud {
        /* margin: 0 auto; */
        font-family: Georgia, 'Times New Roman', Times, serif;
    }

    #chart {
        margin: 0 auto;
        
        
    }

    #bidenSentencesBox {
        width: 100%;
        height: 200 px;
        overflow-y: scroll;
        border: 10px black;
        padding: 10px;

    }

    #trumpSentencesBox {
        width: 100%;
        height: 200 px;
        overflow-y: scroll;
        border: 10px black;
        padding: 10px;

    }
</style>
</body>
</html>